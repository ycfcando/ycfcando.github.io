## Docker

> ä¸€ä¸ªå¿«æ·ï¼Œéå†çš„éƒ¨ç½²é¡¹ç›®å·¥å…·ã€‚
> [docker å®˜ç½‘](https://www.docker.com/)

- [x] ğŸ€ **Windows ä¸‹è½½**ï¼šDownload Docker Desktop -> Download For Window - AMD64
- [x] ğŸ **Linux ä¸‹è½½**ï¼šDownload Docker Desktop -> Download For Linux

### **ä½¿ç”¨**ç¬¬ä¸€æ­¥: é…ç½® Dockerfile æ–‡ä»¶

> docker ä¼šæ ¹æ® Dockerfile æ–‡ä»¶å°†é¡¹ç›®æ‰“åŒ…æˆé•œåƒæ–‡ä»¶ï¼Œ

> [é…ç½®æ–‡æ¡£](https://docs.docker.com/reference/dockerfile/)

**ä¸¾ä¾‹**ï¼š

```dockerfile
# åˆ›å»ºä¸€ä¸ªæ„å»ºå¹¶è®¾ç½®åŸºç¡€é•œåƒï¼Œå¹¶ä¸ºæ„å»ºè®¾å®šåç§° builder
FROM node:22.14-alpine AS builder
# ä¸ºæ„å»ºè®¾ç½®å·¥ä½œè·¯å¾„ /image
WORKDIR /image
# ä»æ‰§è¡Œé…ç½®è·¯å¾„ä¸­æ‹·è´ package.json å’Œ package-lock.json è‡³ /image
COPY package.json package-lock.json* ./
# åœ¨ /image æ‰§è¡Œå®‰è£…ä¾èµ–å‘½ä»¤
RUN npm ci --registry=https://registry.npm.taobao.org
# å°†æ‰§è¡Œé…ç½®è·¯å¾„ä¸‹æ–‡ä»¶è‡³ /image
COPY . .
# åœ¨ /image æ‰§è¡Œæ‰“åŒ…
RUN npm run build
# åˆ›å»ºå¦ä¸€ä¸ªæ„å»ºå¹¶è®¾ç½®åŸºç¡€é•œåƒï¼Œä¸ºæ„å»ºè®¾å®šåç§° runner
FROM node:22.14-alpine AS runner
# ä¸ºæ„å»ºè®¾ç½®å·¥ä½œè·¯å¾„ /app
WORKDIR /app
# ä»ä¸Šä¸€ä¸ªæ„å»º builder æ‹·è´ç›¸å…³æ–‡ä»¶è‡³ /app
COPY --from=builder /image/package.json ./package.json
COPY --from=builder /image/package-lock.json ./package-lock.json
COPY --from=builder /image/node_modules ./node_modules
COPY --from=builder /image/.next ./.next
COPY --from=builder /image/src/mdx ./src/mdx
# è®¾ç½®nextç›¸å…³ç¯å¢ƒå˜é‡: ç”Ÿäº§ã€ç«¯å£3000
ENV NODE_ENV=production
ENV PORT=3000
# æš´éœ²ç«¯å£
EXPOSE ${PORT}
# è®¾å®šé•œåƒå¯åŠ¨å‘½ä»¤
CMD ["npm", "start"]
```

#### å°æŠ€å·§ 1: ç”¨ä½¿ç”¨ .dockerignore æ–‡ä»¶è®¾å®šæ‰§è¡Œ COPY æ—¶è¦å¿½è§†çš„æ–‡ä»¶æˆ–ç›®å½•

1. åˆ›å»º .dockerignore æ–‡ä»¶
2. è®¾å®šè¦å¿½è§†çš„æ–‡ä»¶ï¼Œä¸¾ä¾‹ï¼š

```.dockerignore
node_modules
.gitignore
.git
Dockerfile
.dockerignore
docker-compose.yml
```

3. `FROM <image>[:<tag>] [AS <name>]`: åˆ›å»ºæ„å»ºå¹¶è®¾ç½®åŸºç¡€é•œåƒï¼Œ`image`å¯ä»¥æ˜¯åç§°æˆ– idï¼Œ`tag`å¯é€‰ä¸ºé•œåƒå®šä¹‰çš„æ ‡ç­¾
   `AS <name>`ä¸ºæ„å»ºå–å
4. `WORKDIR <path>`: ä¸ºæ„å»ºè®¾å®šå·¥ä½œè·¯å¾„ï¼Œå³ä¸ºå¸¸ç”¨å‘½ä»¤è®¾å®šå·¥ä½œç›®å½•ï¼Œ`path`å¯ä»¥æ˜¯ç»å¯¹è·¯å¾„æˆ–ç›¸å¯¹è·¯å¾„
5. `COPY [OPTIONS] <src...> <dest>`: æ‹·è´æºæ–‡ä»¶è‡³æ„å»ºè·¯å¾„ï¼Œ`src`ä¸ºæºè·¯å¾„ï¼Œå¯ä»¥æ˜¯ç»å¯¹å¯ä»¥æ˜¯ç›¸å¯¹è·¯å¾„ï¼Œ
   ç›¸å¯¹è·¯å¾„å¯¹åº” Dockerfile æ‰§è¡Œæ–‡ä»¶ç›®å½•ã€‚`dest`ä¸ºæ„å»ºè·¯å¾„ï¼Œä¸º`WORKDIR`è®¾å®šè·¯å¾„ï¼›`OPTIONS`å¯é€‰å‚æ•°ï¼Œ`--from=builder`
   è¡¨ç¤ºä»ä¸Šä¸€ä¸ªæ„å»ºæ‹·è´æ–‡ä»¶ï¼Œæ­¤æ—¶`src`ä¸ºä¸Šä¸€ä¸ªæ„å»ºè·¯å¾„
6. `RUN <command...>`: æ‰§è¡Œ Shell å‘½ä»¤
7. `ENV <key>=<value> [<key>=<value...>]`: ç¯å¢ƒå˜é‡ï¼Œ`key`ä¸ºåç§°`value`ä¸ºå€¼ï¼Œå®ƒä»¬å¯ä»¥åœ¨æ„å»ºé˜¶æ®µçš„å¤§éƒ¨åˆ†å‘½ä»¤ä¸­ä½¿ç”¨ã€‚
8. `EXPOSE <port>`: æš´éœ²ç«¯å£ï¼Œæ²¡æœ‰å®é™…ç”¨å¤„åªæ˜¯ç”¨äºæ–‡æ¡£è®°å½•ï¼Œä¾¿äºè¿è¡Œæ—¶çŸ¥é“æ˜ å°„å“ªä¸ªç«¯å£
9. `CMD ["executable",<param...>]`: è®¾å®šé•œåƒå¯åŠ¨å‘½ä»¤ï¼Œä½¿ç”¨ exec å‘½ä»¤æ ¼å¼å³æ•°ç»„å½¢å¼`[]`

### **ä½¿ç”¨**ç¬¬äºŒæ­¥ï¼šæ„å»ºé•œåƒ

1. æ‰§è¡Œ `docker build [OPTIONS] <name> <path>` å‘½ä»¤æ„å»ºé•œåƒ
   1. name: é•œåƒåç§°
   2. path: Dockerfile æ–‡ä»¶è·¯å¾„

**ä¸¾ä¾‹**

- æ„å»ºå¸¦æ ‡ç­¾é•œåƒ: `docker build -t hypoxia-blog:1.0.0 .`
- ä¸ä¾èµ–ç¼“å­˜ä¸”æ˜¾ç¤ºå®Œæ•´æ—¥å¿—æ„å»ºé•œåƒ: `docker build --no-cache --progress=plain -t hypoxia-blog:1.0.0 .`

### **ä½¿ç”¨**ç¬¬ä¸‰éƒ¨: è®¾å®š docker-compose.yml æ–‡ä»¶

> - docker æ ¹æ® docker-compose.yml æ–‡ä»¶å°†é•œåƒéƒ¨ç½²æˆæœåŠ¡
> - [é…ç½®æ–‡æ¡£](https://docs.docker.com/reference/compose-file/)

**ä¸¾ä¾‹**

```yml
# åˆ›å»ºæœåŠ¡
services:
  # æœåŠ¡å
  hypoxia-blog:
    # åŒ…è£¹æœåŠ¡çš„å®¹å™¨å
    container_name: hypoxia-blog
    # å®¹å™¨å†…çš„é•œåƒ
    image: hypoxia-blog:1.0.0
    # å®¹å™¨æœåŠ¡ä¸ä¸»æœºçš„ç«¯å£æ˜ å°„
    ports:
      - "3000:3000"
    # è®¾å®šç¯å¢ƒå˜é‡
    environment:
      - NODE_ENV=production
```

1. `services`: é¡¶éƒ¨å±æ€§ç”¨äºè®¾å®šå®¹å™¨æœåŠ¡ï¼Œå³åº”ç”¨æœåŠ¡
2. `services.<key>`: services ä¸‹å±æ€§ï¼Œè‡ªå®šä¹‰å®ƒæ˜¯æ¯ä¸ªæœåŠ¡çš„åç§°
3. `<key>.container_name`: è®¾å®šåŒ…è£¹æœåŠ¡çš„å®¹å™¨å
4. `image`: å®¹å™¨å†…çš„é•œåƒï¼Œå¯ä»¥æ˜¯ id å¯ä»¥æ˜¯åç§°
5. `ports`: ä¸»æœºç«¯å’Œå®¹å™¨çš„ç«¯å£æ˜ å°„
6. `environment`: è®¾å®šçš„ç¯å¢ƒå˜é‡

### **ä½¿ç”¨**ç¬¬å››éƒ¨ï¼šéƒ¨ç½²æœåŠ¡

**ä¸¾ä¾‹**

1. åå°éƒ¨ç½²é•œåƒ: `docker-compose up -d`

## Linux å…³äº Docker å‘½ä»¤

- æŸ¥çœ‹æœåŠ¡å™¨ç³»ç»Ÿ: `uname -a`
- å¯åŠ¨ docker æœåŠ¡: `sudo systemctl start docker`
- è®¾ç½® docker æœåŠ¡è‡ªåŠ¨å¯åŠ¨ : `sudo systemctl enable docker`
- æ¸…ç©º docker æœªä½¿ç”¨èµ„æº: `docker system prune -a -f`
- æŸ¥çœ‹æ‰€æœ‰å®¹å™¨ï¼š`docker ps -a`
- å¦‚ä½•è¿è¡Œå®¹å™¨: `docker ps`
- é•œåƒå…³è” dockerhub ä»“åº“: `docker tag local-image:tagname new-repo:tagname`
- æ‹‰å–çš„é•œåƒèµ„æº: `docker pull new-repo:tagname`
- åœæ­¢ docker å®¹å™¨: `docker stop <container id>`
- åˆ—å‡ºæ‰€æœ‰é•œåƒ: `docker images`
- åˆ é™¤ docker å®¹å™¨: `docker rm <container id>`
- åˆ é™¤ image: `docker rmi [<imageId>|<imageName>]`
